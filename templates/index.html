<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Career Counselor</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base Styles & Resets */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #e0eafc; /* Light blue background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            color: #333;
            line-height: 1.6;
        }

        /* Container - The main chat wrapper */
        .container {
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
            width: 100%;
            max-width: 760px; /* Slightly wider for better content flow */
            height: 700px; /* Increased height */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease-in-out;
        }

        /* Header */
        .header {
            /* Gemini-inspired gradient */
            background: linear-gradient(90deg, #6200EE 0%, #BB86FC 100%); 
            color: #ffffff;
            padding: 25px 30px; /* Increased padding */
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 2; /* Ensure it's above other elements */
        }

        .header h1 {
            font-size: 1.9em; /* Slightly smaller for balance */
            font-weight: 600;
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }

        .header p {
            font-size: 0.95em;
            opacity: 0.9;
        }

        /* Chat Container & Messages */
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative; /* Important for absolute positioning of welcome message */
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px; /* Consistent padding */
            background: #fdfdfd; /* Very light background */
            border-radius: 0 0 16px 16px; /* Match container border-radius */
            scroll-behavior: smooth; /* Smooth scrolling for new messages */
        }

        .message {
            margin-bottom: 18px; /* Consistent spacing */
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* User Message */
        .user-message {
            display: flex; /* Use flex to align right */
            justify-content: flex-end;
        }

        .user-message .bubble {
            background: #e0eafc; /* Light blue, subtle */
            color: #333;
            padding: 12px 18px;
            border-radius: 18px 18px 4px 18px; /* Modern bubble shape */
            display: inline-block; /* Still inline-block for bubble sizing */
            max-width: 75%; /* Slightly more width */
            word-wrap: break-word;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            font-size: 0.95em;
        }

        /* AI Message */
        .ai-message {
            display: flex;
            align-items: flex-start;
            gap: 12px; /* Slightly more space between avatar and bubble */
        }

        /* New container for the overlapping avatar and loader */
        .ai-avatar-container {
            position: relative;
            width: 32px; /* Fixed size for both avatar and loader */
            height: 32px;
            flex-shrink: 0;
            margin-top: 2px; /* Adjust for text baseline */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Star Wrapper for consistent sizing and positioning */
        .star-wrapper, .gemini-loader-wrapper {
            position: absolute; /* Overlap within ai-avatar-container */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            /* Transition for visibility and opacity changes */
            transition: opacity 0.3s ease-in-out, visibility 0s linear 0.3s; 
            /* Start hidden by default, unless .visible is applied */
            opacity: 0;
            visibility: hidden;
        }

        .star-wrapper.visible, .gemini-loader-wrapper.visible {
            opacity: 1;
            visibility: visible;
            transition-delay: 0s; /* Show immediately when .visible is added */
        }

        /* The actual star SVG container */
        .ai-avatar {
            width: 100%;
            height: 100%;
            display: block; /* Remove extra space below SVG */
            /* Smooth transitions for transform/filter changes within animation states */
            transition: transform 0.3s ease-in-out, filter 0.3s ease-in-out; 
            position: relative;
        }

        .ai-avatar svg {
            width: 100%;
            height: 100%;
            display: block; /* Remove extra space below SVG */
        }

        /* Enhanced Star Animations */
        
        /* Idle pulse animation for active stars */
        @keyframes enhanced-idle-pulse {
            0% { 
                transform: scale(1) rotate(0deg); 
                filter: drop-shadow(0 0 4px rgba(98, 0, 238, 0.3)); 
            }
            25% { 
                transform: scale(1.03) rotate(3deg); 
                filter: drop-shadow(0 0 8px rgba(187, 134, 252, 0.5)); 
            }
            50% { 
                transform: scale(1.05) rotate(0deg); 
                filter: drop-shadow(0 0 12px rgba(98, 0, 238, 0.7)); 
            }
            75% { 
                transform: scale(1.03) rotate(-3deg); 
                filter: drop-shadow(0 0 8px rgba(187, 134, 252, 0.5)); 
            }
            100% { 
                transform: scale(1) rotate(0deg); 
                filter: drop-shadow(0 0 4px rgba(98, 0, 238, 0.3)); 
            }
        }

        /* Thinking animation with orbital particles (star-based) */
        @keyframes thinking-rotation {
            0% { transform: rotate(0deg) scale(1.1); }
            100% { transform: rotate(360deg) scale(1.1); }
        }

        @keyframes thinking-glow {
            0%, 100% { 
                filter: drop-shadow(0 0 8px rgba(98, 0, 238, 0.8)) 
                        drop-shadow(0 0 16px rgba(187, 134, 252, 0.6)) 
                        drop-shadow(0 0 24px rgba(98, 0, 238, 0.4)); 
            }
            50% { 
                filter: drop-shadow(0 0 12px rgba(98, 0, 238, 1)) 
                        drop-shadow(0 0 24px rgba(187, 134, 252, 0.8)) 
                        drop-shadow(0 0 36px rgba(98, 0, 238, 0.6)); 
            }
        }

        /* Particle orbit animation */
        @keyframes particle-orbit {
            0% { transform: translate(-50%, -50%) rotate(0deg) translateX(12px); } /* Smaller radius for welcome star particles */
            100% { transform: translate(-50%, -50%) rotate(360deg) translateX(12px); }
        }

        @keyframes particle-orbit-reverse {
            0% { transform: translate(-50%, -50%) rotate(0deg) translateX(8px); } /* Smaller radius for welcome star particles */
            100% { transform: translate(-50%, -50%) rotate(-360deg) translateX(8px); }
        }

        /* Typing bounce and spin animation with glow */
        @keyframes typing-bounce {
            0% { transform: translateY(0) scale(1) rotate(0deg); filter: drop-shadow(0 0 4px rgba(98, 0, 238, 0.3)); }
            25% { transform: translateY(-2px) scale(1.02) rotate(90deg); filter: drop-shadow(0 0 8px rgba(187, 134, 252, 0.5)); }
            50% { transform: translateY(-4px) scale(1.05) rotate(180deg); filter: drop-shadow(0 0 12px rgba(98, 0, 238, 0.7)); }
            75% { transform: translateY(-2px) scale(1.02) rotate(270deg); filter: drop-shadow(0 0 8px rgba(187, 134, 252, 0.5)); }
            100% { transform: translateY(0) scale(1) rotate(360deg); filter: drop-shadow(0 0 4px rgba(98, 0, 238, 0.3)); }
        }

        /* Star state classes */
        .star-wrapper.active .ai-avatar {
            animation: enhanced-idle-pulse 4s ease-in-out infinite;
        }

        .star-wrapper.thinking .ai-avatar {
            animation: thinking-rotation 2.5s linear infinite, thinking-glow 2s ease-in-out infinite alternate; /* Slower thinking animation */
            position: relative;
        }

        .star-wrapper.thinking .ai-avatar::before,
        .star-wrapper.thinking .ai-avatar::after {
            content: '';
            position: absolute;
            width: 4px;
            height: 4px;
            background: radial-gradient(circle, #BB86FC 0%, #6200EE 100%);
            border-radius: 50%;
            box-shadow: 0 0 6px rgba(187, 134, 252, 0.8);
            /* Center the particle within the avatar, then let keyframes handle orbit */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Initial centering */
        }

        .star-wrapper.thinking .ai-avatar::before {
            animation: particle-orbit 3.5s linear infinite; /* Slower particle orbit */
        }

        .star-wrapper.thinking .ai-avatar::after {
            animation: particle-orbit-reverse 3s linear infinite; /* Slower particle orbit */
        }

        .star-wrapper.typing .ai-avatar {
            animation: typing-bounce 1.5s ease-in-out infinite; /* Made typing animation slower */
        }

        /* Historical messages: dim and smaller */
        .star-wrapper.historical .ai-avatar {
            animation: none;
            filter: grayscale(60%) opacity(0.6);
            transform: scale(0.9);
        }

        /* Welcome message large star */
        .welcome-message .star-wrapper.logo-large {
            width: 70px; /* Larger welcome logo */
            height: 70px;
            margin: 0 auto 20px; /* More margin */
            position: static; /* OVERRIDE absolute positioning to make it a flex item */
            /* Ensure it's fully visible and interactive regardless of generic .star-wrapper styles */
            opacity: 1; 
            visibility: visible;
            transition: none; /* No transition for this specific static element */
        }
        /* Ensure the welcome message's star is also visible by default HTML structure */
        .welcome-message .star-wrapper.logo-large.visible {
            opacity: 1;
            visibility: visible;
        }


        .typing-text {
            min-height: 20px; /* Ensure space for cursor */
        }

        .cursor {
            display: inline-block;
            background-color: #333; /* Cursor color matches text */
            width: 2px;
            height: 1em; /* Relative to font size */
            animation: blink 1s infinite;
            margin-left: 2px;
            vertical-align: text-bottom;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Input Area */
        .input-container {
            padding: 15px 20px; /* Generous padding */
            background: #ffffff;
            border-top: 1px solid #f0f0f0; /* Subtle border */
            display: flex;
            gap: 12px; /* Consistent spacing */
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .message-input {
            flex: 1;
            padding: 14px 20px; /* Larger padding for better touch targets */
            border: 1px solid #dcdfe4; /* Softer border */
            border-radius: 28px; /* More rounded */
            font-size: 1em;
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
            background: #f8f8f8; /* Slight background for input */
            color: #333;
        }

        .message-input::placeholder {
            color: #999;
        }

        .message-input:focus {
            border-color: #6200EE; /* Focus color from Gemini palette */
            box-shadow: 0 0 0 3px rgba(98, 0, 238, 0.2); /* Soft focus ring */
            background: #fff;
        }

        .send-btn {
            background: linear-gradient(90deg, #6200EE 0%, #BB86FC 100%); /* Matching header gradient */
            color: white;
            border: none;
            padding: 14px 28px; /* Larger button */
            border-radius: 28px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.2s ease, background 0.3s ease; /* Added background to transition */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            letter-spacing: 0.5px;
        }

        .send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(98, 0, 238, 0.3);
        }

        .send-btn:disabled {
            background: #cad2da; /* Muted disabled color */
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.7;
        }

        /* New style for 'Stop' button state */
        .send-btn.stop-state {
            background: #ff4d4f; /* A red color for stop */
            box-shadow: 0 4px 8px rgba(255, 77, 79, 0.3);
        }

        .send-btn.stop-state:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 12px rgba(255, 77, 79, 0.5);
        }


        /* Controls Area */
        .controls {
            padding: 12px 20px; /* Adjusted padding */
            background: #f8f9fa; /* Lighter background */
            border-top: 1px solid #eeeeee;
            display: flex; /* Use flex for alignment */
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
            color: #666;
        }

        .clear-btn {
            background: #ff7f7f; /* Softer red */
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px; /* More rounded */
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 500;
            transition: background 0.2s ease;
        }

        .clear-btn:hover {
            background: #e65c5c;
        }

        .controls small {
            opacity: 0.8;
            font-style: italic;
        }

        /* Welcome Message */
        .welcome-message {
            text-align: center;
            color: #7f8c8d;
            padding: 50px 30px; /* More generous padding */
            font-style: italic;
            display: flex; /* Ensures flex properties for centering */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%; /* Occupy full height of parent container */
            width: 100%; /* Occupy full width of parent container */
            position: absolute; /* Overlay messages content */
            top: 0;
            left: 0;
            background: #fdfdfd; /* Match messages background for seamless overlay */
            z-index: 2; /* Ensure it's above messages but below input/header */
            transition: opacity 0.3s ease-out; /* Smooth fade out */
        }

        .welcome-message.hidden {
            opacity: 0;
            pointer-events: none; /* Make it unclickable when hidden */
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .container {
                height: 100vh;
                border-radius: 0;
                box-shadow: none;
            }
            
            .header h1 {
                font-size: 1.6em;
            }
            
            .header p {
                font-size: 0.9em;
            }

            .user-message .bubble,
            .ai-message .bubble {
                max-width: 90%;
                font-size: 0.9em;
            }

            .messages {
                padding: 15px;
            }

            .input-container {
                padding: 12px 15px;
                flex-wrap: wrap; /* Allow input and button to wrap */
            }

            .message-input {
                padding: 12px 18px;
                font-size: 0.95em;
                width: 100%; /* Take full width on small screens */
                margin-bottom: 8px; /* Space below input */
            }

            .send-btn {
                padding: 12px 24px;
                font-size: 0.95em;
                width: 100%; /* Take full width */
            }

            .controls {
                flex-direction: column;
                gap: 8px;
                padding: 10px 15px;
            }

            .clear-btn {
                font-size: 0.8em;
                padding: 7px 14px;
            }
            
            .controls small {
                text-align: center;
            }

            .star-wrapper, .gemini-loader-wrapper {
                width: 28px; /* Slightly smaller avatar on mobile */
                height: 28px;
            }

            .welcome-message .star-wrapper.logo-large {
                width: 60px;
                height: 60px;
                margin-bottom: 15px;
            }

            .welcome-message h3 {
                font-size: 1.2em;
            }

            .welcome-message p {
                font-size: 0.9em;
            }
        }

        /* Gemini Loader Styles */
        /* .gemini-loader-wrapper is now contained within ai-avatar-container */
        .gemini-loader {
            width: 100%;
            height: 100%;
            position: relative;
        }

        .gemini-loader span {
            position: absolute;
            width: 6px; /* Dot size */
            height: 6px;
            background-color: #6200EE; /* Dot color */
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* Center dot initially */
            opacity: 0; /* Initially hidden */
            animation: gemini-dot-orbit 2s ease-in-out infinite, gemini-dot-fade 2s ease-in-out infinite;
        }

        .gemini-loader span:nth-child(1) { animation-delay: 0s, 0s; }
        .gemini-loader span:nth-child(2) { animation-delay: 0.66s, 0.66s; }
        .gemini-loader span:nth-child(3) { animation-delay: 1.32s, 1.32s; }

        @keyframes gemini-dot-orbit {
            0% { transform: translate(-50%, -50%) rotate(0deg) translateX(12px) scale(0.5); opacity: 0; }
            20% { opacity: 1; transform: translate(-50%, -50%) rotate(72deg) translateX(12px) scale(1); }
            40% { transform: translate(-50%, -50%) rotate(144deg) translateX(12px); }
            60% { transform: translate(-50%, -50%) rotate(216deg) translateX(12px); }
            80% { transform: translate(-50%, -50%) rotate(288deg) translateX(12px) scale(0.5); }
            100% { transform: translate(-50%, -50%) rotate(360deg) translateX(12px) scale(0); opacity: 0; }
        }

        @keyframes gemini-dot-fade {
            0%, 100% { opacity: 0; }
            20%, 80% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Star.ai</h1>
            <p>Your personal guide to career success</p>
        </div>
        
        <div class="chat-container">
            <div class="welcome-message" id="welcomeMessage">
                <div class="star-wrapper logo-large visible" id="welcomeStar"> <div class="ai-avatar">
                        <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C12.5523 2 13 2.44772 13 3V11H21C21.5523 11 22 11.4477 22 12C22 12.5523 21.5523 13 21 13H13V21C13 21.5523 12.5523 22 12 22C11.4477 22 11 21.5523 11 21V13H3C2.44772 13 2 12.5523 2 12C2 11.4477 2.44772 11 3 11H11V3C11 2.44772 11.4477 2 12 2Z" fill="#BB86FC"/>
                            <circle cx="12" cy="12" r="3" fill="#6200EE"/>
                        </svg>
                    </div>
                </div>
                <h3>Welcome to Star.ai - Your AI Career Counselor!</h3>
                <p>I'm here to help you navigate your career path. Ask me anything about career guidance, resume tips, job market insights, and more!</p>
            </div>

            <div class="messages" id="messages">
                </div>
            
        </div>
        
        <div class="input-container">
            <input type="text" class="message-input" id="messageInput" placeholder="Ask about your career goals, job search, skills development..." />
            <button class="send-btn" id="sendBtn">Send</button>
        </div>
        
        <div class="controls">
            <button class="clear-btn" id="clearBtn">Clear Chat</button>
            <small>ðŸ’¡ Try asking: "Help me plan my career transition" or "How do I improve my resume?"</small>
        </div>
    </div>

    <script>
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const clearBtn = document.getElementById('clearBtn');
        const welcomeMessageDiv = document.getElementById('welcomeMessage');
        const welcomeStar = document.getElementById('welcomeStar'); // Get reference to the welcome star

        // State variables for scrolling and typing
        let isTyping = false; // True when the AI is actively typing
        let userScrolledUp = false; // True if the user has manually scrolled up
        let typingTimer = null; // Timer for the typing animation
        let messageQueue = []; // Queue for messages to be processed

        // SVG code for the Gemini-like star avatar
        const geminiStarSVG = `
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C12.5523 2 13 2.44772 13 3V11H21C21.5523 11 22 11.4477 22 12C22 12.5523 21.5523 13 21 13H13V21C13 21.5523 12.5523 22 12 22C11.4477 22 11 21.5523 11 21V13H3C2.44772 13 2 12.5523 2 12C2 11.4477 2.44772 11 3 11H11V3C11 2.44772 11.4477 2 12 2Z" fill="#BB86FC"/>
                <circle cx="12" cy="12" r="3" fill="#6200EE"/>
            </svg>
        `;

        /**
         * Checks if the user's scroll position is near the bottom of the messages container.
         * @returns {boolean} True if near bottom, false otherwise.
         */
        function isNearBottom() {
            const tolerance = 50; // pixels from bottom to consider "near"
            return messagesContainer.scrollTop + messagesContainer.clientHeight >= messagesContainer.scrollHeight - tolerance;
        }

        /**
         * Event listener for messages container scroll.
         * Updates `userScrolledUp` based on scroll position.
         */
        messagesContainer.addEventListener('scroll', () => {
            // Only update userScrolledUp if AI is currently typing 
            if (isTyping) { 
                userScrolledUp = !isNearBottom();
            } else {
                userScrolledUp = !isNearBottom();
            }
        });

        /**
         * Manages the animation state classes for star avatars.
         * Sets historical state for previous AI messages, and specific states for active/typing/thinking stars.
         * This function now expects to be called on a specific starWrapper element directly,
         * or it will iterate through all and apply historical.
         * @param {HTMLElement} targetStarWrapper - The specific .star-wrapper element to animate, or null to only update historical.
         * @param {string} state - The desired state ('active', 'typing', 'thinking', 'historical').
         */
        function setStarAnimationState(targetStarWrapper, state) {
            // Clear all animation classes from all stars, but preserve logo-large
            const allStarWrappers = document.querySelectorAll('.star-wrapper');
            allStarWrappers.forEach(wrapper => {
                // Keep 'logo-large' if it exists, remove other state classes
                if (wrapper.classList.contains('logo-large')) {
                    wrapper.classList.remove('active', 'typing', 'thinking', 'historical');
                } else {
                    wrapper.classList.remove('active', 'typing', 'thinking', 'historical', 'logo-large');
                }
            });

            // Apply historical state to all previous AI messages that are currently visible
            const allAiMessages = messagesContainer.querySelectorAll('.ai-message');
            allAiMessages.forEach(message => {
                const starWrapper = message.querySelector('.star-wrapper.visible'); // Only target visible stars
                if (starWrapper && starWrapper !== targetStarWrapper) {
                    starWrapper.classList.add('historical');
                }
            });
            
            // Apply the specific animation state to the target star wrapper if provided
            if (targetStarWrapper) {
                targetStarWrapper.classList.add(state);
            } 
            // The welcome message star's state is handled directly in loadHistory/clearChat for better control.
        }

        /**
         * Adds a new message to the chat display.
         * @param {string} text - The message text.
         * @param {boolean} isUser - True if it's a user message, false for AI message.
         * @returns {object} {messageDiv: HTMLElement, typingDiv: HTMLElement, aiAvatarContainer: HTMLElement, starWrapperDiv: HTMLElement, geminiLoaderWrapper: HTMLElement} for AI messages.
         * {messageDiv: HTMLElement} for user messages.
         */
        function addMessage(text, isUser = false) {
            // Hide welcome message once chat starts
            if (welcomeMessageDiv) {
                welcomeMessageDiv.classList.add('hidden'); 
                // Also hide the welcome star and remove its active state
                if (welcomeStar) {
                    welcomeStar.classList.remove('visible', 'active');
                }
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'user-message' : 'ai-message'}`;
            
            if (isUser) {
                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = 'bubble';
                bubbleDiv.textContent = text;
                messageDiv.appendChild(bubbleDiv);
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                return { messageDiv: messageDiv }; // Return only messageDiv for user
            } else {
                // Create the common container for both loader and star
                const aiAvatarContainer = document.createElement('div');
                aiAvatarContainer.className = 'ai-avatar-container';

                // Create star wrapper (initially not visible)
                const starWrapperDiv = document.createElement('div');
                starWrapperDiv.className = 'star-wrapper'; // Will have 'visible' added later
                starWrapperDiv.innerHTML = `<div class="ai-avatar">${geminiStarSVG}</div>`;
                
                // Create Gemini loader wrapper (visible initially)
                const geminiLoaderWrapper = document.createElement('div');
                geminiLoaderWrapper.className = 'gemini-loader-wrapper visible'; 
                geminiLoaderWrapper.innerHTML = `
                    <div class="gemini-loader">
                        <span class="dot-1"></span>
                        <span class="dot-2"></span>
                        <span class="dot-3"></span>
                    </div>
                `;
                
                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = 'bubble';
                
                const typingDiv = document.createElement('div');
                typingDiv.className = 'typing-text'; // This will hold the AI's response
                
                bubbleDiv.appendChild(typingDiv);
                aiAvatarContainer.appendChild(geminiLoaderWrapper); // Add loader to container
                aiAvatarContainer.appendChild(starWrapperDiv); // Add star to container, initially hidden

                messageDiv.appendChild(aiAvatarContainer); // Add the container to the message
                messageDiv.appendChild(bubbleDiv);
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight; // Scroll to new message placeholder

                return { messageDiv: messageDiv, typingDiv: typingDiv, aiAvatarContainer: aiAvatarContainer, starWrapperDiv: starWrapperDiv, geminiLoaderWrapper: geminiLoaderWrapper };
            }
        }

        /**
         * Simulates typing animation for AI responses.
         * @param {HTMLElement} element - The element to type into (e.g., a div inside the bubble).
         * @param {string} text - The full text to type.
         * @param {HTMLElement} starWrapper - The star wrapper associated with this message.
         * @param {HTMLElement} geminiLoaderWrapper - The Gemini loader wrapper to hide.
         * @param {number} speed - Typing speed in milliseconds per character.
         */
        function typeText(element, text, starWrapper, geminiLoaderWrapper, speed = 30) {
            isTyping = true;
            userScrolledUp = !isNearBottom(); // Re-evaluate scroll state at the start of typing
            
            // Seamless transition: hide loader, show star, then set star animation state
            if (geminiLoaderWrapper) {
                geminiLoaderWrapper.classList.remove('visible'); // Start fading out loader
                geminiLoaderWrapper.classList.add('hidden');
            }
            if (starWrapper) {
                starWrapper.classList.remove('hidden'); // Start fading in star
                starWrapper.classList.add('visible');
                setStarAnimationState(starWrapper, 'typing'); // Apply typing animation state
            }

            // Immediately update the button state to "Stop" when typing starts
            updateSendButtonState();

            element.innerHTML = ''; // Clear existing content
            
            // Add a blinking cursor
            const cursorSpan = document.createElement('span');
            cursorSpan.className = 'cursor';
            element.appendChild(cursorSpan);

            let i = 0;
            let scrollCount = 0;
            const scrollThreshold = 3; // Scroll after every N characters

            function type() {
                if (i < text.length) {
                    // Check if typing was externally stopped
                    if (!isTyping) { // If isTyping was set to false by a 'Stop' click
                        element.innerHTML = text.substring(0, i); // Finalize with what was typed so far
                        if (starWrapper) {
                            setStarAnimationState(starWrapper, 'active'); // Set star to active idle
                        }
                        updateSendButtonState(); // Update button to 'Send'
                        return; // Stop typing
                    }

                    const charsToAdd = Math.min(Math.floor(Math.random() * 2) + 1, text.length - i); // Type 1-2 chars at a time
                    const textSegment = text.substring(i, i + charsToAdd);
                    
                    // Insert text before the cursor
                    cursorSpan.insertAdjacentHTML('beforebegin', textSegment);
                    i += charsToAdd;
                    
                    scrollCount += charsToAdd;
                    
                    // Only auto-scroll if the user hasn't scrolled up
                    if (scrollCount >= scrollThreshold && !userScrolledUp) {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                        scrollCount = 0; // Reset scroll counter
                    }
                    
                    // Clear any existing timer and set a new one to prevent multiple timers
                    if (typingTimer) {
                        clearTimeout(typingTimer);
                    }
                    
                    typingTimer = setTimeout(type, speed);
                } else {
                    // Typing finished: remove cursor and ensure full text is displayed
                    element.innerHTML = text; 
                    
                    // Perform a final scroll to bottom if user hasn't scrolled up
                    if (!userScrolledUp) {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                    
                    isTyping = false; // Typing is complete
                    userScrolledUp = !isNearBottom(); // Final check of scroll state
                    
                    // Set the star to active idle state after typing
                    if (starWrapper) {
                        setStarAnimationState(starWrapper, 'active');
                    } else {
                        console.warn("Star wrapper not found after typing completed.");
                    }
                    processQueue(); // Process next message in queue
                    updateSendButtonState(); // Update button to 'Send' after typing completes or queue is processed
                }
            }
            
            // Initial delay before typing starts for a more natural feel
            typingTimer = setTimeout(type, 500); 
        }

        /**
         * Handles sending a message to the backend.
         */
        async function sendMessage() {
            // If AI is currently typing, this click is a 'Stop' command
            if (isTyping) {
                // Stop the typing animation immediately
                if (typingTimer) {
                    clearTimeout(typingTimer);
                    typingTimer = null;
                }
                isTyping = false; // Set typing status to false
                messageQueue = []; // Clear the queue if stop is pressed

                // Find the last AI message and ensure its content is finalized
                const lastAiMessage = messagesContainer.querySelector('.ai-message:last-child');
                if (lastAiMessage) {
                    const typingDiv = lastAiMessage.querySelector('.typing-text');
                    const starWrapper = lastAiMessage.querySelector('.star-wrapper');
                    if (typingDiv && starWrapper) {
                        // Remove cursor and set current content (it might be partial)
                        typingDiv.innerHTML = typingDiv.textContent; // Finalize the typed content
                        setStarAnimationState(starWrapper, 'active'); // Set star to active idle
                    }
                }
                
                updateSendButtonState(); // Update button to 'Send'
                return; // Do not proceed with sending a new message
            }

            const message = messageInput.value.trim();
            if (!message) return; // Don't send empty messages

            // Add user message to display immediately
            addMessage(message, true); 
            messageInput.value = ''; // Clear input field

            // Enqueue the message
            messageQueue.push(message);

            // If not currently typing, start processing the queue
            if (!isTyping) { 
                processQueue();
            } else {
                // This path implies the user just pressed Enter while something was already processing or typing.
                // The `updateSendButtonState` will keep the button disabled and say 'Wait...'
                updateSendButtonState(); 
            }
        }

        /**
         * Processes messages from the queue.
         */
        async function processQueue() {
            if (messageQueue.length === 0 || isTyping) { // If AI is typing, don't start new processing
                updateSendButtonState();
                return;
            }

            const messageToProcess = messageQueue.shift(); // Get the next message from the queue

            // Indicate processing state
            sendBtn.disabled = true; // Disable button while processing
            sendBtn.textContent = 'Processing...';
            sendBtn.classList.remove('stop-state'); // Ensure original styling

            // Add AI message placeholder, which now includes the loader, and set loader visible
            const aiMessageElements = addMessage('', false);
            const typingDiv = aiMessageElements.typingDiv;
            const aiStarWrapper = aiMessageElements.starWrapperDiv;
            const geminiLoaderWrapper = aiMessageElements.geminiLoaderWrapper;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: messageToProcess }) // Send the queued message
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                let actualResponse = data.response;
                
                const promptPrefix = "You are a professional AI Career Counselor called Star with expertise in: - Career guidance and planning - Resume and interview advice - Industry trends and job market insights - Skills development recommendations - Career transition strategies - Professional networking guidance - Salary negotiation tips - Work-life balance advice Always provide helpful, supportive, and actionable career advice. Ask clarifying questions to better understand the user's situation, goals, and background. Be encouraging while remaining realistic about career prospects and challenges. Start conversations by introducing yourself and asking how you can help with their career journey today.";
                if (actualResponse.startsWith(promptPrefix)) {
                    actualResponse = actualResponse.substring(promptPrefix.length).trim();
                }

                // Start typing into the existing placeholder, which will trigger the loader-to-star transition
                // This call to typeText will set isTyping to true and update the button to 'Stop'
                typeText(typingDiv, actualResponse, aiStarWrapper, geminiLoaderWrapper); 

            } catch (error) {
                console.error('Error sending message:', error);
                // Hide loader and show star in error state
                if (geminiLoaderWrapper) {
                    geminiLoaderWrapper.classList.remove('visible');
                    geminiLoaderWrapper.classList.add('hidden');
                }
                if (aiStarWrapper) {
                    aiStarWrapper.classList.remove('hidden');
                    aiStarWrapper.classList.add('visible', 'historical'); // Show star, but in a muted state for error
                }
                typingDiv.textContent = "Oops! Something went wrong. Please try again later.";
                isTyping = false; // Ensure typing is false on error
                messageQueue = []; // Clear queue on error
                updateSendButtonState(); // Update button state
            } 
        }

        /**
         * Updates the state of the send button based on input and typing status.
         */
        function updateSendButtonState() {
            if (isTyping) { // If AI is currently typing
                sendBtn.disabled = false; // Always enabled for stop action
                sendBtn.textContent = 'Stop';
                sendBtn.classList.add('stop-state'); // Apply red styling
                messageInput.focus();
            } else if (messageQueue.length > 0) { // If there are messages in the queue waiting to be processed
                sendBtn.disabled = true;
                sendBtn.textContent = 'Wait...';
                sendBtn.classList.remove('stop-state'); // Ensure original styling
                messageInput.focus();
            } else if (messageInput.value.trim().length > 0) { // If input has text and no typing/queue
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
                sendBtn.classList.remove('stop-state'); // Ensure original styling
                messageInput.focus();
            } else { // If input is empty and no typing/queue
                sendBtn.disabled = true;
                sendBtn.textContent = 'Send';
                sendBtn.classList.remove('stop-state'); // Ensure original styling
                messageInput.focus();
            }
        }


        /**
         * Loads chat history from the backend.
         */
        async function loadHistory() {
            try {
                const response = await fetch('/api/history');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.messages && data.messages.length > 0) {
                    // Hide welcome message if history exists
                    if (welcomeMessageDiv) {
                        welcomeMessageDiv.classList.add('hidden');
                        if (welcomeStar) { // Hide and deactivate welcome star
                            welcomeStar.classList.remove('visible', 'active');
                        }
                    }
                    messagesContainer.innerHTML = ''; // Clear initial welcome message before loading history
                    data.messages.forEach(msg => {
                        // For historical messages, we add them directly without typing animation
                        const userMsgDiv = document.createElement('div');
                        userMsgDiv.className = 'message user-message';
                        const userBubble = document.createElement('div');
                        userBubble.className = 'bubble';
                        userBubble.textContent = msg.user;
                        userMsgDiv.appendChild(userBubble);
                        messagesContainer.appendChild(userMsgDiv);

                        const aiMsgDiv = document.createElement('div');
                        aiMsgDiv.className = 'message ai-message';

                        // Create the common container for both loader and star for historical messages
                        const aiAvatarContainer = document.createElement('div');
                        aiAvatarContainer.className = 'ai-avatar-container';

                        const starWrapperDiv = document.createElement('div');
                        starWrapperDiv.className = 'star-wrapper visible historical'; // Visible and historical
                        starWrapperDiv.innerHTML = `<div class="ai-avatar">${geminiStarSVG}</div>`;
                        
                        // Gemini loader not needed for historical messages, but create a hidden one for consistency if ever needed
                        const geminiLoaderWrapper = document.createElement('div');
                        geminiLoaderWrapper.className = 'gemini-loader-wrapper hidden'; 
                        geminiLoaderWrapper.innerHTML = `
                            <div class="gemini-loader">
                                <span class="dot-1"></span>
                                <span class="dot-2"></span>
                                <span class="dot-3"></span>
                            </div>
                        `;

                        const aiBubble = document.createElement('div');
                        aiBubble.className = 'bubble';
                        aiBubble.textContent = msg.ai;

                        aiAvatarContainer.appendChild(geminiLoaderWrapper);
                        aiMsgDiv.appendChild(aiAvatarContainer); // Add the container to the message
                        aiMsgDiv.appendChild(aiBubble);
                        messagesContainer.appendChild(aiMsgDiv);
                    });
                    messagesContainer.scrollTop = messagesContainer.scrollHeight; // Scroll to bottom of history
                    setStarAnimationState(null, 'active'); // Set the last message's star to active
                } else {
                    // If no history, ensure welcome message is visible and its star is animated
                    if (welcomeMessageDiv) {
                        welcomeMessageDiv.classList.remove('hidden');
                        // Directly activate welcome star
                        if (welcomeStar) {
                            welcomeStar.classList.add('visible', 'active');
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading history:', error);
                // If history fails to load, ensure welcome message is still shown as a fallback
                if (welcomeMessageDiv) {
                    welcomeMessageDiv.classList.remove('hidden');
                    if (welcomeStar) {
                        welcomeStar.classList.add('visible', 'active');
                    }
                }
            } finally {
                updateSendButtonState(); // Ensure button state is correct after history load
            }
        }

        /**
         * Clears the chat history.
         */
        async function clearChat() {
            try {
                // Stop any ongoing typing animation and clear the queue
                if (typingTimer) {
                    clearTimeout(typingTimer);
                    typingTimer = null;
                }
                isTyping = false;
                messageQueue = [];

                const response = await fetch('/api/clear');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                if (data.status === 'cleared') {
                    messagesContainer.innerHTML = ''; // Clear messages from UI
                    // Show welcome message again
                    if (welcomeMessageDiv) {
                        welcomeMessageDiv.classList.remove('hidden');
                        // Directly activate welcome star
                        if (welcomeStar) {
                            welcomeStar.classList.add('visible', 'active');
                        }
                    }
                }
            } catch (error) {
                console.error('Error clearing chat:', error);
                // Optionally inform user about error
            } finally {
                updateSendButtonState(); // Ensure button state is correct after clearing
            }
        }

        // Event Listeners
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            // Check if Enter is pressed and the button is not disabled (which it won't be if it's 'Stop')
            if (e.key === 'Enter' && !sendBtn.disabled) {
                sendMessage();
            }
        });
        messageInput.addEventListener('input', updateSendButtonState); // Update button state on input change

        clearBtn.addEventListener('click', clearChat);

        // Initial setup on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await clearChat(); // Clear chat history on every load
            await loadHistory(); // Then load history (will be empty, showing welcome)
            // Initial button state is set by updateSendButtonState called in loadHistory/clearChat
        });

    </script>
</body>
</html>